<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>列印狀態面板 /status2</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#10161d;--panel2:#151c24;--text:#e6eef8;--muted:#9fb3c8;
    --accent:#3ea6ff;--ok:#4ade80;--danger:#ef4444;--border:#223246;
    --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"Helvetica Neue",Arial;
    background:
      radial-gradient(1200px 600px at 100% -20%, #12202d, transparent),
      radial-gradient(800px 500px at -20% 120%, #1a2a38, transparent),
      var(--bg);
    color:var(--text);
  }
  .container{max-width:95vw;margin:20px auto;padding:0 8px;}
  .card{
    width:100%;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:var(--shadow);
  }
  .header{padding:18px 18px 0}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px;margin-top:6px;word-break:break-all}
  .controls{position:relative;display:flex;gap:10px;align-items:center;padding:14px 18px 18px;flex-wrap:wrap}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .btn{border:1px solid #2b4256;background:linear-gradient(180deg,#15324a,#10273a);color:#d9f1ff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .table-wrap{border-top:1px solid var(--border);position:relative}
  .scroller{
    max-height:70vh;overflow:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  }
  table{
    width:max(1400px,100%);border-collapse:separate;border-spacing:0;table-layout:auto;min-width:100%;
  }
  thead th{
    position:sticky;top:0;background:#0f151c;z-index:2;text-align:left;
    font-size:13px;color:#c7d7ea;padding:10px 12px;
    border-bottom:1px solid var(--border);border-right:1px solid var(--border);
    white-space:nowrap;min-width:120px;
  }
  thead th:first-child,tbody td:first-child{
    position:sticky;left:0;z-index:3;background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-right:1px solid var(--border);min-width:220px;
  }
  tbody td{
    padding:10px 12px;font-size:13px;color:#e6eef8;
    border-bottom:1px solid #17212c;border-right:1px solid #17212c;white-space:nowrap;
  }
  tbody tr:hover td{background:#0f1922}
  .statusbar{
    display:flex;justify-content:space-between;gap:12px;
    padding:12px 16px;color: var(--muted);
    border-top:1px solid var(--border);background:#0c1218;
    font-size:12px;border-radius:0 0 16px 16px
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .err{color:#ffd1d1}
  .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
  .tag.live{background:#10273a;color:#d9f1ff;border-color:#2b4256}

  /* 欄位過濾下拉 */
  .filter-pop{
    position:absolute; top:54px; left:18px; width:260px; max-height:340px;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:8px; overflow:auto; display:none; z-index:30;
  }
  .filter-pop.show{ display:block; }
  .filter-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 8px; border-bottom:1px solid var(--border); margin-bottom:6px;
  }
  .filter-row{
    display:flex; gap:8px; align-items:center;
    padding:6px 8px; border-bottom:1px solid #17212c;
  }
  .filter-row:last-child{ border-bottom:0 }
  .filter-row label{
    flex:1; font-size:13px; color:var(--text); cursor:pointer
  }
  .mini{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>列印狀態（/status2）</h1>
        <div class="sub">
          資料來源：
          <code id="srcText"></code>
          （每 60 秒自動刷新）
        </div>
      </div>

      <div class="controls">
        <button id="btnFilter" class="btn">顯示 / 隱藏欄位</button>
        <button id="btnRefresh" class="btn">立即刷新</button>

        <!-- 欄位過濾下拉 -->
        <div id="filterPop" class="filter-pop" role="dialog" aria-label="欄位過濾">
          <div class="filter-head">
            <div class="mini">勾選要顯示的欄位</div>
            <div>
              <button id="btnAllOn" class="btn" style="padding:4px 8px">全選</button>
              <button id="btnAllOff" class="btn" style="padding:4px 8px">全不選</button>
            </div>
          </div>
          <div id="filterList"></div>
        </div>
      </div>

      <div class="table-wrap">
        <div class="scroller">
          <table id="t">
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="statusbar">
        <div>
          <span>筆數：<span id="count">0</span></span>
          <span style="margin-left:12px">最後更新：<span id="updated">—</span></span>
        </div>
        <div class="mono err" id="msg"></div>
      </div>
    </div>
  </div>

<script>
/* ==========================================================
   ✅ 欄位設定（唯一需要維護的地方）
   想新增/移除/改名稱，直接改這裡就好，其他程式會自動跟著更新。

   key   = 後端 /devices 回傳時 metrics 裡面的 suffix，例如 "_action"
   label = 表格欄位顯示名稱 + 過濾面板 checkbox 顯示文字
   ========================================================== */
const COLUMN_CONFIG = [
  { key: "_a",         label: "A" },
  { key: "_action",    label: "Action" },
  { key: "_al",        label: "AL" },
  { key: "_c",         label: "C" },
  { key: "_cm",        label: "CM" },
  { key: "_dn",        label: "DN" },
  { key: "_fs",        label: "FS" },
  { key: "_fwversion", label: "FWVersion" },
  { key: "_he",        label: "HE" },
  { key: "_id",        label: "ID" },
  { key: "_k",         label: "K" },
  { key: "_m",         label: "M" },
  { key: "_p",         label: "P" },
  { key: "_page",      label: "Page" },
  { key: "_tsrm",      label: "TSRM" },
  { key: "_w",         label: "W" },
  { key: "_y",         label: "Y" },
  { key: "_yk",        label: "YK" },
  { key: "_ymov",      label: "Ymov" },
  { key: "_z1",        label: "Z1" },
  { key: "_z2",        label: "Z2" },
];

/* ==========================================================
   ✅ API Query 設定
   prefix   = 我們要看的 entity 開頭
   suffixes = 自動把 COLUMN_CONFIG.key 串成逗號清單
   DEVICES_URL = /devices?prefix=...&suffix=... （實際打的 API）
   這也會被顯示到畫面上的 <code id="srcText">
   ========================================================== */
const DEFAULT_PREFIX = "sensor.testprint_";
const SUFFIX_LIST = COLUMN_CONFIG.map(c => c.key).join(",");
const DEVICES_URL = `/devices?prefix=${encodeURIComponent(DEFAULT_PREFIX)}&suffix=${encodeURIComponent(SUFFIX_LIST)}`;

document.getElementById("srcText").textContent = DEVICES_URL;

/* ---------- 偏好持久化（哪些欄位有顯示） ---------- */
const LS_KEY = "status2_visible_columns_v3"; // 改版就換 key，避免舊資料衝突

function loadVisibleSet(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const arr = JSON.parse(raw);
    // 過濾掉已經不存在的欄位 key
    if(Array.isArray(arr)) {
      return new Set(arr.filter(k => COLUMN_CONFIG.some(c => c.key === k)));
    }
  }catch(_){}
  return null;
}

function saveVisibleSet(set){
  localStorage.setItem(LS_KEY, JSON.stringify([...set]));
}

// 預設：全部欄位都顯示
let visibleSet = loadVisibleSet() || new Set(COLUMN_CONFIG.map(c => c.key));

/* ---------- DOM 快取 ---------- */
const elHead = document.getElementById('thead');
const elBody = document.getElementById('tbody');
const elCount = document.getElementById('count');
const elUpdated = document.getElementById('updated');
const elMsg = document.getElementById('msg');
const elFilter = document.getElementById('filterPop');
const elFilterList = document.getElementById('filterList');
const REFRESH_MS = 60000;

/* ---------- 工具 ---------- */
function fmt(v){
  return (v===null || v===undefined) ? "" : String(v);
}

// 目前啟用的欄位 (依 COLUMN_CONFIG 順序過濾)
function currentColumns(){
  return COLUMN_CONFIG.filter(col => visibleSet.has(col.key));
}

function renderHead(){
  // 第一欄固定"裝置"，後面依照 currentColumns()
  const cols = ["裝置", ...currentColumns().map(col => col.label)];
  elHead.innerHTML = cols.map(c => `<th>${c}</th>`).join("");
}

function toRows(payload){
  const rows = [];
  const devices = Array.isArray(payload?.devices) ? payload.devices : [];
  for(const d of devices){
    const id = d?.device_id ?? "";
    const m = d?.metrics ?? {};
    const row = { device: id };
    for(const col of currentColumns()){
      row[col.key] = m[col.key]?.value ?? "";
    }
    rows.push(row);
  }
  return rows;
}

function renderBody(rows){
  if(!rows.length){
    elBody.innerHTML = `<tr><td colspan="${1+currentColumns().length}" style="text-align:center;color:#9fb3c8;padding:18px">無資料</td></tr>`;
    elCount.textContent = "0";
    return;
  }

  elBody.innerHTML = rows.map(r=>{
    const cells = [`<td>${fmt(r.device)}</td>`];
    for(const col of currentColumns()){
      cells.push(`<td>${fmt(r[col.key])}</td>`);
    }
    return `<tr>${cells.join("")}</tr>`;
  }).join("");

  elCount.textContent = String(rows.length);
}

async function loadLive(){
  const res = await fetch(DEVICES_URL, { headers:{ "Accept":"application/json" }});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

async function refresh(){
  elMsg.textContent = "";
  try{
    const data = await loadLive();
    renderHead();
    renderBody(toRows(data));
    elUpdated.textContent = new Date().toLocaleString();
  }catch(e){
    elMsg.textContent = "讀取失敗："+e.message;
  }
}

/* ---------- 欄位過濾 UI ---------- */
function rebuildFilterList(){
  elFilterList.innerHTML = COLUMN_CONFIG.map(col => `
    <div class="filter-row">
      <input
        id="chk_${col.key}"
        type="checkbox"
        ${visibleSet.has(col.key) ? "checked":""}
        onchange="toggleField('${col.key}', this.checked)" />
      <label for="chk_${col.key}">${col.label}</label>
    </div>
  `).join("");
}

// 提供給 inline onchange 用
window.toggleField = function(key, on){
  if(on) visibleSet.add(key);
  else   visibleSet.delete(key);
  saveVisibleSet(visibleSet);
  refresh();
};

document.getElementById('btnFilter').addEventListener('click', ()=>{
  if(elFilter.classList.contains('show')) {
    elFilter.classList.remove('show');
    return;
  }
  rebuildFilterList();
  elFilter.classList.add('show');
});

document.addEventListener('click', (e)=>{
  const btn = document.getElementById('btnFilter');
  if(!elFilter.contains(e.target) && e.target !== btn){
    elFilter.classList.remove('show');
  }
});

document.getElementById('btnAllOn').addEventListener('click', ()=>{
  visibleSet = new Set(COLUMN_CONFIG.map(c => c.key));
  saveVisibleSet(visibleSet);
  rebuildFilterList();
  refresh();
});

document.getElementById('btnAllOff').addEventListener('click', ()=>{
  visibleSet = new Set();
  saveVisibleSet(visibleSet);
  rebuildFilterList();
  refresh();
});

/* ---------- 啟動 ---------- */
document.getElementById('btnRefresh').addEventListener('click', refresh);
refresh();
setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>